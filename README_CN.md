# VLM 图像识别脚本

一个使用视觉语言模型（VLM）分析图像并识别其中物体的 Python 脚本。支持基于云端和本地的处理模式。

## 功能特性

- **双模式处理**：可选择云端（X.AI Grok-4）和本地（Ollama LLaVA）VLM 处理
- **物体识别**：分析图像以识别和定位物体
- **坐标检测**：提供已识别物体的 x,y 坐标，支持动态缩放
- **置信度评分**：返回每个检测结果的置信度水平
- **视觉反馈**：在检测到的物体上绘制标记并保存带注释的图像
- **音频反馈**：语音播报识别结果
- **系数控制尺寸**：可配置的图像调整大小，跨模式统一尺寸
- **代理绕过**：本地 Ollama 连接的自动代理绕过
- **全面日志记录**：详细记录所有操作和时间信息

## 系统要求
- Python 3.7+
- **云端模式**：X.AI API 密钥（在 X.AI 注册）
- **本地模式**：安装了 LLaVA 模型的 Ollama
- 库依赖：`requests`、`pillow`、`base64`、`sys`、`subprocess`、`pathlib`
- 语音合成：`espeak` 或 `festival`（Linux/macOS）

## 安装

1. 克隆或下载此仓库
2. 安装所需包：
   ```bash
   pip install -r requirements.txt
   ```

### 云端模式设置
将您的 X.AI API 密钥设置为环境变量：
```bash
export XAI_API_KEY="your_api_key_here"
```

### 本地模式设置
安装并配置带有 LLaVA 的 Ollama：
```bash
# 安装 Ollama（访问 https://ollama.ai 获取说明）
# 拉取 LLaVA 模型
ollama pull llava
```

## 使用方法

### 云端模式（默认）
```bash
python imageRecogVLM.py path/to/your/image.jpg
```

### 本地模式
```bash
python imageRecogVLM.py path/to/your/image.jpg --local
```

脚本将：
1. 加载图像并调整大小以优化处理
2. 将图像发送到选定的 VLM（云端或本地）进行分析
3. 解析响应以提取物体信息
4. 在检测到的物体上绘制星形标记，支持坐标缩放
5. 保存带注释的图像
6. 提供语音反馈
7. 记录所有结果，包含详细的时间信息

## 配置

您可以修改脚本顶部的几个常量：

- `RESIZE_WIDTH`：图像处理的目标宽度（默认：256px）
- `LOCAL_RESIZE_COEFFICIENT`：本地模式尺寸系数（默认：1.0）
- `RESIZE_QUALITY`：JPEG 压缩质量（默认：85）
- 云端和本地模式的各种超时和重试设置

## 输出

脚本生成：
- **控制台输出**：详细记录物体检测结果，包含坐标和置信度评分
- **带注释图像**：原始图像上标记检测到的物体（`annotated_output.jpg`）
- **音频反馈**：检测结果的语音确认
- **时间信息**：两种处理模式的性能指标

## 输出示例
```
2024-01-15 10:30:45 - 处理图像：sampleImages/image_000078.jpg
2024-01-15 10:30:45 - 使用本地模式，Ollama LLaVA
2024-01-15 10:30:45 - 图像调整为 256x192（原始：640x480）
2024-01-15 10:30:47 - 本地 API 响应时间：2.15 秒
2024-01-15 10:30:47 - 发现 2 个物体：
  - 瓶子（置信度：0.85）位置 (128, 96) → 缩放至 (320, 240)
  - 杯子（置信度：0.72）位置 (200, 150) → 缩放至 (500, 375)
2024-01-15 10:30:48 - 带注释图像已保存为：annotated_output.jpg
```

## 故障排除

### 云端模式问题
- 验证 `XAI_API_KEY` 环境变量设置正确
- 检查网络连接
- 确保 API 配额未超限

### 本地模式问题
- 验证 Ollama 正在运行：`ollama list`
- 检查 LLaVA 模型是否已安装：`ollama pull llava`
- 确保端口 11434 可用
- 如果在企业防火墙后，检查代理设置

### 一般问题
- 验证图像文件存在且格式受支持（JPG、PNG）
- 检查 Python 依赖是否已安装
- 确保语音合成系统可用（`espeak` 或 `festival`）

## 技术说明

- **坐标系统**：原点 (0,0) 在左上角，坐标从处理后的图像尺寸缩放到原始图像尺寸
- **图像处理**：调整尺寸时保持纵横比
- **代理处理**：本地模式下自动绕过本地主机连接的代理
- **错误处理**：全面的异常处理和回退响应
- **性能**：本地模式通常在重复查询时更快，云端模式适合偶尔使用

## 扩展脚本

脚本采用模块化设计。您可以：
- 通过实现 API 接口模式添加新的 VLM 提供商
- 为不同的检测任务修改提示模板
- 自定义视觉标记系统（星形、框等）
- 使用坐标输出集成机器人控制系统
- 添加批量处理多张图像的支持

## 注意事项
- 脚本期望 VLM API 返回与原始图像相同分辨率的坐标
- 如果未找到物体，脚本会提示并且不会绘制星形标记
- 支持多个物体，每个都会用黄色星形标记
